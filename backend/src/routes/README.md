# 用户管理路由

## 概述

本模块实现了用户管理相关的 API 端点，包括用户注册和姓名验证功能。

## API 端点

### POST /api/users/register

注册新用户。

**请求体:**
```json
{
  "username": "张三"
}
```

**成功响应 (200):**
```json
{
  "success": true,
  "userId": "uuid-string",
  "message": "注册成功"
}
```

**错误响应:**

- **400 Bad Request** - 姓名无效
  ```json
  {
    "success": false,
    "error": "姓名不能为空"
  }
  ```
  或
  ```json
  {
    "success": false,
    "error": "姓名不能超过50个字符"
  }
  ```

- **409 Conflict** - 姓名已存在
  ```json
  {
    "success": false,
    "error": "姓名已存在"
  }
  ```

- **500 Internal Server Error** - 服务器错误
  ```json
  {
    "success": false,
    "error": "服务器错误"
  }
  ```

**验证规则:**
- 姓名不能为空或纯空格
- 姓名长度不能超过50个字符
- 姓名必须唯一（不能重复）
- 姓名会自动去除前后空格
- 初始积分为0

### GET /api/users/check/:username

检查姓名是否可用。

**参数:**
- `username` - 要检查的姓名（URL 参数）

**成功响应 (200):**
```json
{
  "available": true
}
```
或
```json
{
  "available": false
}
```

**错误响应 (400):**
```json
{
  "available": false,
  "error": "姓名不能为空"
}
```

## 测试

### 安装依赖

在运行测试之前，请确保已安装所有依赖：

```bash
cd cave-exploration-game/backend
npm install
```

### 运行单元测试

```bash
npm test
```

### 运行属性测试

```bash
npm run test:pbt
```

### 运行所有测试

```bash
npm run test:all
```

## 实现细节

### 姓名验证逻辑

1. **非空验证**: 检查姓名是否为空字符串或纯空格
2. **长度验证**: 检查姓名长度是否不超过50个字符
3. **唯一性验证**: 通过数据库 UNIQUE 约束确保姓名唯一
4. **空格处理**: 自动去除姓名前后的空格

### 错误处理

- **唯一约束违反**: 捕获 SQLite 的 UNIQUE constraint 错误，返回友好的错误信息
- **数据库错误**: 记录详细错误日志，返回通用错误信息
- **输入验证错误**: 返回具体的验证错误信息

### 数据库操作

使用 `database` 模块进行数据库操作：
- `database.run()` - 执行插入操作
- `database.queryOne()` - 查询单个用户记录

## 相关需求

- **需求 1.2**: 验证姓名非空且未被使用
- **需求 1.3**: 创建用户会话并进入游戏主界面
- **需求 1.4**: 显示错误提示并要求重新输入
- **需求 1.5**: 拒绝提交并显示提示信息

## 属性测试

本模块实现了以下属性测试（Property-Based Tests）：

### 属性 1: 用户姓名验证

**验证需求**: 1.2, 1.4, 1.5

**属性描述**: 对于任何用户输入的姓名字符串，系统应该拒绝空字符串、纯空格字符串，以及已存在的姓名，并且只接受非空且唯一的姓名。

**测试用例**:
1. 拒绝空字符串和纯空格字符串
2. 拒绝超过50字符的姓名
3. 接受有效的唯一姓名
4. 拒绝重复的姓名
5. 姓名应该被去除前后空格
6. 拒绝非字符串类型的姓名
7. 验证姓名唯一性约束的一致性

每个测试用例运行 20-100 次迭代，使用 fast-check 库生成随机输入。
